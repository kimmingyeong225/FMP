<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>ëœë¤ ë§¤ì¹­ ì±„íŒ… (ì´ì œ ë‚´ ì´ë¦„/ë‚˜ í‘œì‹œ)</title>
    <!-- SockJS & Stomp.js -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat-box {
          width: 600px;
          height: 400px;
          border: 1px solid #ccc;
          overflow-y: scroll;
          padding: 10px;
          margin-top: 10px;
        }
        #message-input { width: 500px; }
        .system-message { color: gray; font-style: italic; }
        #match-div, #chat-div { margin-top: 20px; }
        #matchBtn, #sendBtn, #leaveBtn {
            padding: 5px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <h2>ğŸŸ¢ ëœë¤ ë§¤ì¹­ ì±„íŒ…</h2>

    <!-- 1) ë§¤ì¹­ ì‹œì‘ ë²„íŠ¼ -->
    <div id="match-div">
        <button id="matchBtn">ë§¤ì¹­ ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- 2) ë§¤ì¹­ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ -->
    <div id="matching-div" style="display: none;">
        <p>ğŸ”„ ë§¤ì¹­ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <!-- 3) ë§¤ì¹­ ì™„ë£Œ ì‹œ ì±„íŒ… ì˜ì—­ í‘œì‹œ -->
    <div id="chat-div" style="display: none;">
        <p>ğŸ†” ë°© ID: <span id="room-id-display"></span></p>
        <div id="chat-box"></div>
        <div style="margin-top: 10px;">
            <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="sendBtn" disabled>ì „ì†¡</button>
            <button id="leaveBtn">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

 <script>
let stompClient = null;
let roomId = null;
let myUserId = null;  // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë‚˜ì˜ ID

// ë§¤ì¹­ ì‹œì‘ ë²„íŠ¼ í´ë¦­
document.getElementById("matchBtn").onclick = function() {
    document.getElementById("match-div").style.display = "none";
    document.getElementById("matching-div").style.display = "block";
    requestMatch();
};

function requestMatch() {
    fetch("/match/random")
        .then(res => res.json())
        .then(data => {
            myUserId = data.userId; // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë‚˜ì˜ ID ì €ì¥
            if (data.roomId) {
                onMatched(data.roomId);
            } else {
                setTimeout(requestMatch, 1000);
            }
        })
        .catch(err => {
            document.getElementById("matching-div").innerHTML =
              "<p style='color:red;'>ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
            console.error("ë§¤ì¹­ ì˜¤ë¥˜:", err);
        });
}

function onMatched(returnedRoomId) {
    roomId = returnedRoomId;
    document.getElementById("matching-div").style.display = "none";
    document.getElementById("chat-div").style.display = "block";
    document.getElementById("room-id-display").textContent = roomId;
    connectToChatRoom();
    document.getElementById("message-input").focus();
}

function connectToChatRoom() {
    const socket = new SockJS("/ws-chat");
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, function(frame) {
        console.log("STOMP ì—°ê²° ì„±ê³µ:", frame);

        // ê°™ì€ ë°© IDë¡œ êµ¬ë… ì‹œì‘
        stompClient.subscribe("/topic/chat/" + roomId, function(msg) {
            appendChatMessage(JSON.parse(msg.body));
        });

        document.getElementById("sendBtn").disabled = false;
    }, function(error) {
        appendSystemMessage("ì±„íŒ… ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });
}

function sendChatMessage() {
    const input = document.getElementById("message-input");
    const content = input.value.trim();
    if (!content || !stompClient) return;

    const chatMessage = {
        senderId: myUserId,  // ì‹¤ì œ IDë¥¼ ë³´ë‚´ì§€ë§Œ í™”ë©´ì—ëŠ” â€œë‚˜â€ í˜¹ì€ â€œìµëª…â€ìœ¼ë¡œë§Œ ë³´ì„
        text: content,
        timestamp: new Date().toISOString()
    };
    stompClient.send("/app/chat/" + roomId, {}, JSON.stringify(chatMessage));
    input.value = "";
}

// **ë©”ì‹œì§€ í‘œì‹œ ë¶€ë¶„ë§Œ ìˆ˜ì •**
function appendChatMessage(msg) {
    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");

    const time = msg.timestamp ? formatTime(msg.timestamp) : "";
    // ë‚´ ë©”ì‹œì§€ì´ë©´ â€œë‚˜â€, ì•„ë‹ˆë©´ í•­ìƒ â€œìµëª…â€
    const who = (msg.senderId === myUserId) ? "ë‚˜" : "ìµëª…";

    div.innerHTML = `<b>${who}:</b> ${msg.text}
                     <span style="color:#aaa;font-size:12px;"> ${time}</span>`;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function appendSystemMessage(msg) {
    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = "system-message";
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2,"0")
         + ":" + d.getMinutes().toString().padStart(2,"0");
}

document.getElementById("sendBtn").onclick = sendChatMessage;
document.getElementById("message-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter") sendChatMessage();
});
document.getElementById("leaveBtn").onclick = () => location.reload();
</script>

</body>
</html>
