<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>랜덤 매칭 채팅 (이제 내 이름/나 표시)</title>
    <!-- SockJS & Stomp.js -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat-box {
          width: 600px;
          height: 400px;
          border: 1px solid #ccc;
          overflow-y: scroll;
          padding: 10px;
          margin-top: 10px;
        }
        #message-input { width: 500px; }
        .system-message { color: gray; font-style: italic; }
        #match-div, #chat-div { margin-top: 20px; }
        #matchBtn, #sendBtn, #leaveBtn {
            padding: 5px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <h2>🟢 랜덤 매칭 채팅</h2>

    <!-- 1) 매칭 시작 버튼 -->
    <div id="match-div">
        <button id="matchBtn">매칭 시작하기</button>
    </div>

    <!-- 2) 매칭 중 메시지 표시 -->
    <div id="matching-div" style="display: none;">
        <p>🔄 매칭 중... 잠시만 기다려주세요.</p>
    </div>

    <!-- 3) 매칭 완료 시 채팅 영역 표시 -->
    <div id="chat-div" style="display: none;">
        <p>🆔 방 ID: <span id="room-id-display"></span></p>
        <div id="chat-box"></div>
        <div style="margin-top: 10px;">
            <input type="text" id="message-input" placeholder="메시지를 입력하세요..." />
            <button id="sendBtn" disabled>전송</button>
            <button id="leaveBtn">나가기</button>
        </div>
    </div>

 <script>
let stompClient = null;
let roomId = null;
let myUserId = null;  // 서버에서 내려준 나의 ID

// 매칭 시작 버튼 클릭
document.getElementById("matchBtn").onclick = function() {
    document.getElementById("match-div").style.display = "none";
    document.getElementById("matching-div").style.display = "block";
    requestMatch();
};

function requestMatch() {
    fetch("/match/random")
        .then(res => res.json())
        .then(data => {
            myUserId = data.userId; // 서버에서 내려준 나의 ID 저장
            if (data.roomId) {
                onMatched(data.roomId);
            } else {
                setTimeout(requestMatch, 1000);
            }
        })
        .catch(err => {
            document.getElementById("matching-div").innerHTML =
              "<p style='color:red;'>매칭 중 오류가 발생했습니다.</p>";
            console.error("매칭 오류:", err);
        });
}

function onMatched(returnedRoomId) {
    roomId = returnedRoomId;
    document.getElementById("matching-div").style.display = "none";
    document.getElementById("chat-div").style.display = "block";
    document.getElementById("room-id-display").textContent = roomId;
    connectToChatRoom();
    document.getElementById("message-input").focus();
}

function connectToChatRoom() {
    const socket = new SockJS("/ws-chat");
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, function(frame) {
        console.log("STOMP 연결 성공:", frame);

        // 같은 방 ID로 구독 시작
        stompClient.subscribe("/topic/chat/" + roomId, function(msg) {
            appendChatMessage(JSON.parse(msg.body));
        });

        document.getElementById("sendBtn").disabled = false;
    }, function(error) {
        appendSystemMessage("채팅 서버 연결에 실패했습니다.");
    });
}

function sendChatMessage() {
    const input = document.getElementById("message-input");
    const content = input.value.trim();
    if (!content || !stompClient) return;

    const chatMessage = {
        senderId: myUserId,  // 실제 ID를 보내지만 화면에는 “나” 혹은 “익명”으로만 보임
        text: content,
        timestamp: new Date().toISOString()
    };
    stompClient.send("/app/chat/" + roomId, {}, JSON.stringify(chatMessage));
    input.value = "";
}

// **메시지 표시 부분만 수정**
function appendChatMessage(msg) {
    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");

    const time = msg.timestamp ? formatTime(msg.timestamp) : "";
    // 내 메시지이면 “나”, 아니면 항상 “익명”
    const who = (msg.senderId === myUserId) ? "나" : "익명";

    div.innerHTML = `<b>${who}:</b> ${msg.text}
                     <span style="color:#aaa;font-size:12px;"> ${time}</span>`;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function appendSystemMessage(msg) {
    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = "system-message";
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2,"0")
         + ":" + d.getMinutes().toString().padStart(2,"0");
}

document.getElementById("sendBtn").onclick = sendChatMessage;
document.getElementById("message-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter") sendChatMessage();
});
document.getElementById("leaveBtn").onclick = () => location.reload();
</script>

</body>
</html>
